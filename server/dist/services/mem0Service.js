"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const mem0ai_1 = require("mem0ai");
const shared_1 = require("shared");
const config_1 = require("../utils/config");
const s3Service_1 = __importDefault(require("./s3Service"));
const transcriptionService_1 = __importDefault(require("./transcriptionService"));
const genai_1 = require("@google/genai");
class Mem0Service {
    constructor() {
        this.genAI = null;
        const config = (0, config_1.getConfig)();
        this.client = new mem0ai_1.MemoryClient({
            apiKey: config.mem0ApiKey,
        });
        this.geminiApiKey = config.geminiApiKey;
        this.geminiModel = config.geminiModel;
        this.genAI = new genai_1.GoogleGenAI({ apiKey: this.geminiApiKey });
    }
    addUserIdFilter(filters, params) {
        filters.AND.push({ user_id: params.userId });
    }
    addDateFilter(filters, params) {
        if (params.dateFrom || params.dateTo) {
            const dateFilter = {};
            if (params.dateFrom) {
                dateFilter.gte = params.dateFrom;
            }
            if (params.dateTo) {
                dateFilter.lte = params.dateTo;
            }
            filters.AND.push({ created_at: dateFilter });
        }
    }
    addTypeFilter(filters, params) {
        if (params.types && params.types.length > 0) {
            const typeFilters = params.types.map((type) => ({
                metadata: { type },
            }));
            filters.AND.push({
                OR: typeFilters,
            });
        }
    }
    addTagFilter(filters, params) {
        if (params.tags && params.tags.length > 0) {
            filters.AND.push({
                metadata: {
                    tags: params.tags,
                },
            });
        }
    }
    async searchEntries(params) {
        console.log("params", JSON.stringify(params, null, 2));
        const filters = {
            AND: [],
        };
        this.addUserIdFilter(filters, params);
        this.addDateFilter(filters, params);
        this.addTypeFilter(filters, params);
        this.addTagFilter(filters, params);
        console.log("filters", JSON.stringify(filters, null, 2));
        const searchOptions = {
            user_id: params.userId,
            filters,
            api_version: "v2",
        };
        const searchResults = await this.client.search(params.query, searchOptions);
        console.log("searchResults", JSON.stringify(searchResults, null, 2));
        return this.parseSearchResults(searchResults);
    }
    parseSearchResults(searchResults) {
        return searchResults.map((result) => ({
            id: result.id,
            userId: result.user_id ?? "",
            memory: result.memory ?? "",
            timestamp: result.metadata.timestamp ?? {},
            tags: result.metadata.tags ?? [],
            mood: result.metadata.mood ?? "",
            location: result.metadata.location ?? {},
            data: result.metadata.data ?? "",
            score: result.score ?? 0,
            type: result.metadata.type ?? shared_1.MediaType.TEXT,
        }));
    }
    async getImageDescription(s3ObjectKey) {
        try {
            const imageData = await s3Service_1.default.getObjectBuffer(s3ObjectKey);
            const originalFilename = s3ObjectKey.split("/").pop() || "journal-image.jpg";
            const imageFile = new File([imageData], originalFilename, {
                type: "image/jpeg",
            });
            const uploadedGeminiFile = await this.genAI.files.upload({
                file: imageFile,
                config: { mimeType: "image/jpeg" },
            });
            const promptText = process.env.IMAGE_DESCRIPTION_PROMPT ||
                "Please describe what's in this image in 1-2 simple sentences. Focus only on the main subject/activity.";
            const result = await this.genAI.models.generateContent({
                model: this.geminiModel,
                contents: (0, genai_1.createUserContent)([
                    (0, genai_1.createPartFromUri)(uploadedGeminiFile.uri, uploadedGeminiFile.mimeType),
                    promptText,
                ]),
            });
            return result.text;
        }
        catch (error) {
            console.error("Error generating image description:", error);
            throw new Error("Error generating image description");
        }
    }
    async getImageMessage(data) {
        const imageDescription = await this.getImageDescription(data);
        return imageDescription;
    }
    async getAudioMessage(data) {
        const audioUrl = await s3Service_1.default.getPresignedUrl(data);
        const transcription = await transcriptionService_1.default.transcribeAudio(audioUrl);
        return transcription;
    }
    async addJournalEntry(entry) {
        let message;
        switch (entry.type) {
            case shared_1.MediaType.TEXT:
                message = entry.data;
                break;
            case shared_1.MediaType.IMAGE:
                message = await this.getImageMessage(entry.data);
                break;
            case shared_1.MediaType.AUDIO:
                message = await this.getAudioMessage(entry.data);
                break;
            default:
                throw new Error(`Unsupported media type: ${entry.type}`);
        }
        const result = await this.client.add(message, {
            user_id: entry.userId,
            metadata: {
                ...entry.metadata,
                data: entry.data,
                type: entry.type,
            },
            api_version: "v2",
            infer: false,
        });
        console.log("result", JSON.stringify(result, null, 2));
        return result;
    }
}
exports.default = new Mem0Service();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVtMFNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmljZXMvbWVtMFNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxtQ0FBNkQ7QUFDN0QsbUNBS2dCO0FBQ2hCLDRDQUE0QztBQUM1Qyw0REFBb0M7QUFDcEMsa0ZBQTBEO0FBQzFELHlDQUl1QjtBQUV2QixNQUFNLFdBQVc7SUFNZjtRQUZRLFVBQUssR0FBUSxJQUFJLENBQUM7UUFHeEIsTUFBTSxNQUFNLEdBQUcsSUFBQSxrQkFBUyxHQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLHFCQUFZLENBQUM7WUFDN0IsTUFBTSxFQUFFLE1BQU0sQ0FBQyxVQUFVO1NBQzFCLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQztRQUN4QyxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7UUFDdEMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLG1CQUFXLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVPLGVBQWUsQ0FDckIsT0FBNEIsRUFDNUIsTUFBeUI7UUFFekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVPLGFBQWEsQ0FDbkIsT0FBNEIsRUFDNUIsTUFBeUI7UUFFekIsSUFBSSxNQUFNLENBQUMsUUFBUSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNyQyxNQUFNLFVBQVUsR0FBUSxFQUFFLENBQUM7WUFDM0IsSUFBSSxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3BCLFVBQVUsQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FB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QUFTLENBQUMsS0FBSztnQkFDbEIsT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2pELE1BQU07WUFDUixLQUFLLGtCQUFTLENBQUMsS0FBSztnQkFDbEIsT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2pELE1BQU07WUFDUjtnQkFDRSxNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM3RCxDQUFDO1FBQ0QsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUU7WUFDNUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxNQUFNO1lBQ3JCLFFBQVEsRUFBRTtnQkFDUixHQUFHLEtBQUssQ0FBQyxRQUFRO2dCQUNqQixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7Z0JBQ2hCLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSTthQUNqQjtZQUNELFdBQVcsRUFBRSxJQUFJO1lBQ2pCLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUNGO0FBRUQsa0JBQWUsSUFBSSxXQUFXLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1lbW9yeSwgTWVtb3J5Q2xpZW50LCBTZWFyY2hPcHRpb25zIH0gZnJvbSBcIm1lbTBhaVwiO1xuaW1wb3J0IHtcbiAgSm91cm5hbEVudHJ5UGF5bG9hZCxcbiAgTWVkaWFUeXBlLFxuICBTZWFyY2hRdWVyeVBhcmFtcyxcbiAgSm91cm5hbEVudHJ5LFxufSBmcm9tIFwic2hhcmVkXCI7XG5pbXBvcnQgeyBnZXRDb25maWcgfSBmcm9tIFwiLi4vdXRpbHMvY29uZmlnXCI7XG5pbXBvcnQgczNTZXJ2aWNlIGZyb20gXCIuL3MzU2VydmljZVwiO1xuaW1wb3J0IHRyYW5zY3JpcHRpb25TZXJ2aWNlIGZyb20gXCIuL3RyYW5zY3JpcHRpb25TZXJ2aWNlXCI7XG5pbXBvcnQge1xuICBHb29nbGVHZW5BSSxcbiAgY3JlYXRlVXNlckNvbnRlbnQsXG4gIGNyZWF0ZVBhcnRGcm9tVXJpLFxufSBmcm9tIFwiQGdvb2dsZS9nZW5haVwiO1xuXG5jbGFzcyBNZW0wU2VydmljZSB7XG4gIHByaXZhdGUgY2xpZW50OiBNZW1vcnlDbGllbnQ7XG4gIHByaXZhdGUgZ2VtaW5pQXBpS2V5OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgZ2VtaW5pTW9kZWw6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBnZW5BSTogYW55ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBjb25zdCBjb25maWcgPSBnZXRDb25maWcoKTtcbiAgICB0aGlzLmNsaWVudCA9IG5ldyBNZW1vcnlDbGllbnQoe1xuICAgICAgYXBpS2V5OiBjb25maWcubWVtMEFwaUtleSxcbiAgICB9KTtcbiAgICB0aGlzLmdlbWluaUFwaUtleSA9IGNvbmZpZy5nZW1pbmlBcGlLZXk7XG4gICAgdGhpcy5nZW1pbmlNb2RlbCA9IGNvbmZpZy5nZW1pbmlNb2RlbDtcbiAgICB0aGlzLmdlbkFJID0gbmV3IEdvb2dsZUdlbkFJKHsgYXBpS2V5OiB0aGlzLmdlbWluaUFwaUtleSB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVXNlcklkRmlsdGVyKFxuICAgIGZpbHRlcnM6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICAgcGFyYW1zOiBTZWFyY2hRdWVyeVBhcmFtc1xuICApIHtcbiAgICBmaWx0ZXJzLkFORC5wdXNoKHsgdXNlcl9pZDogcGFyYW1zLnVzZXJJZCB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkRGF0ZUZpbHRlcihcbiAgICBmaWx0ZXJzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICAgIHBhcmFtczogU2VhcmNoUXVlcnlQYXJhbXNcbiAgKSB7XG4gICAgaWYgKHBhcmFtcy5kYXRlRnJvbSB8fCBwYXJhbXMuZGF0ZVRvKSB7XG4gICAgICBjb25zdCBkYXRlRmlsdGVyOiBhbnkgPSB7fTtcbiAgICAgIGlmIChwYXJhbXMuZGF0ZUZyb20pIHtcbiAgICAgICAgZGF0ZUZpbHRlci5ndGUgPSBwYXJhbXMuZGF0ZUZyb207XG4gICAgICB9XG4gICAgICBpZiAocGFyYW1zLmRhdGVUbykge1xuICAgICAgICBkYXRlRmlsdGVyLmx0ZSA9IHBhcmFtcy5kYXRlVG87XG4gICAgICB9XG4gICAgICBmaWx0ZXJzLkFORC5wdXNoKHsgY3JlYXRlZF9hdDogZGF0ZUZpbHRlciB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZFR5cGVGaWx0ZXIoXG4gICAgZmlsdGVyczogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBwYXJhbXM6IFNlYXJjaFF1ZXJ5UGFyYW1zXG4gICkge1xuICAgIGlmIChwYXJhbXMudHlwZXMgJiYgcGFyYW1zLnR5cGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHR5cGVGaWx0ZXJzID0gcGFyYW1zLnR5cGVzLm1hcCgodHlwZSkgPT4gKHtcbiAgICAgICAgbWV0YWRhdGE6IHsgdHlwZSB9LFxuICAgICAgfSkpO1xuXG4gICAgICBmaWx0ZXJzLkFORC5wdXNoKHtcbiAgICAgICAgT1I6IHR5cGVGaWx0ZXJzLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgYWRkVGFnRmlsdGVyKFxuICAgIGZpbHRlcnM6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICAgcGFyYW1zOiBTZWFyY2hRdWVyeVBhcmFtc1xuICApIHtcbiAgICBpZiAocGFyYW1zLnRhZ3MgJiYgcGFyYW1zLnRhZ3MubGVuZ3RoID4gMCkge1xuICAgICAgZmlsdGVycy5BTkQucHVzaCh7XG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgdGFnczogcGFyYW1zLnRhZ3MsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcHVibGljIGFzeW5jIHNlYXJjaEVudHJpZXMoXG4gICAgcGFyYW1zOiBTZWFyY2hRdWVyeVBhcmFtc1xuICApOiBQcm9taXNlPEpvdXJuYWxFbnRyeVtdPiB7XG4gICAgY29uc29sZS5sb2coXCJwYXJhbXNcIiwgSlNPTi5zdHJpbmdpZnkocGFyYW1zLCBudWxsLCAyKSk7XG4gICAgY29uc3QgZmlsdGVyczogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcbiAgICAgIEFORDogW10sXG4gICAgfTtcbiAgICB0aGlzLmFkZFVzZXJJZEZpbHRlcihmaWx0ZXJzLCBwYXJhbXMpO1xuICAgIHRoaXMuYWRkRGF0ZUZpbHRlcihmaWx0ZXJzLCBwYXJhbXMpO1xuICAgIHRoaXMuYWRkVHlwZUZpbHRlcihmaWx0ZXJzLCBwYXJhbXMpO1xuICAgIHRoaXMuYWRkVGFnRmlsdGVyKGZpbHRlcnMsIHBhcmFtcyk7XG4gICAgY29uc29sZS5sb2coXCJmaWx0ZXJzXCIsIEpTT04uc3RyaW5naWZ5KGZpbHRlcnMsIG51bGwsIDIpKTtcbiAgICBjb25zdCBzZWFyY2hPcHRpb25zOiBTZWFyY2hPcHRpb25zID0ge1xuICAgICAgdXNlcl9pZDogcGFyYW1zLnVzZXJJZCxcbiAgICAgIGZpbHRlcnMsXG4gICAgICBhcGlfdmVyc2lvbjogXCJ2MlwiLFxuICAgIH07XG5cbiAgICBjb25zdCBzZWFyY2hSZXN1bHRzID0gYXdhaXQgdGhpcy5jbGllbnQuc2VhcmNoKHBhcmFtcy5xdWVyeSwgc2VhcmNoT3B0aW9ucyk7XG4gICAgY29uc29sZS5sb2coXCJzZWFyY2hSZXN1bHRzXCIsIEpTT04uc3RyaW5naWZ5KHNlYXJjaFJlc3VsdHMsIG51bGwsIDIpKTtcbiAgICByZXR1cm4gdGhpcy5wYXJzZVNlYXJjaFJlc3VsdHMoc2VhcmNoUmVzdWx0cyk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlU2VhcmNoUmVzdWx0cyhzZWFyY2hSZXN1bHRzOiBNZW1vcnlbXSk6IEpvdXJuYWxFbnRyeVtdIHtcbiAgICByZXR1cm4gc2VhcmNoUmVzdWx0cy5tYXAoKHJlc3VsdCkgPT4gKHtcbiAgICAgIGlkOiByZXN1bHQuaWQsXG4gICAgICB1c2VySWQ6IHJlc3VsdC51c2VyX2lkID8/IFwiXCIsXG4gICAgICBtZW1vcnk6IHJlc3VsdC5tZW1vcnkgPz8gXCJcIixcbiAgICAgIHRpbWVzdGFtcDogcmVzdWx0Lm1ldGFkYXRhLnRpbWVzdGFtcCA/PyB7fSxcbiAgICAgIHRhZ3M6IHJlc3VsdC5tZXRhZGF0YS50YWdzID8/IFtdLFxuICAgICAgbW9vZDogcmVzdWx0Lm1ldGFkYXRhLm1vb2QgPz8gXCJcIixcbiAgICAgIGxvY2F0aW9uOiByZXN1bHQubWV0YWRhdGEubG9jYXRpb24gPz8ge30sXG4gICAgICBkYXRhOiByZXN1bHQubWV0YWRhdGEuZGF0YSA/PyBcIlwiLFxuICAgICAgc2NvcmU6IHJlc3VsdC5zY29yZSA/PyAwLFxuICAgICAgdHlwZTogcmVzdWx0Lm1ldGFkYXRhLnR5cGUgPz8gTWVkaWFUeXBlLlRFWFQsXG4gICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRJbWFnZURlc2NyaXB0aW9uKHMzT2JqZWN0S2V5OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBpbWFnZURhdGEgPSBhd2FpdCBzM1NlcnZpY2UuZ2V0T2JqZWN0QnVmZmVyKHMzT2JqZWN0S2V5KTtcbiAgICAgIGNvbnN0IG9yaWdpbmFsRmlsZW5hbWUgPVxuICAgICAgICBzM09iamVjdEtleS5zcGxpdChcIi9cIikucG9wKCkgfHwgXCJqb3VybmFsLWltYWdlLmpwZ1wiO1xuICAgICAgY29uc3QgaW1hZ2VGaWxlID0gbmV3IEZpbGUoW2ltYWdlRGF0YV0sIG9yaWdpbmFsRmlsZW5hbWUsIHtcbiAgICAgICAgdHlwZTogXCJpbWFnZS9qcGVnXCIsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdXBsb2FkZWRHZW1pbmlGaWxlID0gYXdhaXQgdGhpcy5nZW5BSS5maWxlcy51cGxvYWQoe1xuICAgICAgICBmaWxlOiBpbWFnZUZpbGUsXG4gICAgICAgIGNvbmZpZzogeyBtaW1lVHlwZTogXCJpbWFnZS9qcGVnXCIgfSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBwcm9tcHRUZXh0ID0gcHJvY2Vzcy5lbnYuSU1BR0VfREVTQ1JJUFRJT05fUFJPTVBUIHx8XG4gICAgICAgIFwiUGxlYXNlIGRlc2NyaWJlIHdoYXQncyBpbiB0aGlzIGltYWdlIGluIDEtMiBzaW1wbGUgc2VudGVuY2VzLiBGb2N1cyBvbmx5IG9uIHRoZSBtYWluIHN1YmplY3QvYWN0aXZpdHkuXCI7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZ2VuQUkubW9kZWxzLmdlbmVyYXRlQ29udGVudCh7XG4gICAgICAgIG1vZGVsOiB0aGlzLmdlbWluaU1vZGVsLFxuICAgICAgICBjb250ZW50czogY3JlYXRlVXNlckNvbnRlbnQoW1xuICAgICAgICAgIGNyZWF0ZVBhcnRGcm9tVXJpKFxuICAgICAgICAgICAgdXBsb2FkZWRHZW1pbmlGaWxlLnVyaSxcbiAgICAgICAgICAgIHVwbG9hZGVkR2VtaW5pRmlsZS5taW1lVHlwZVxuICAgICAgICAgICksXG4gICAgICAgICAgcHJvbXB0VGV4dCxcbiAgICAgICAgXSksXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHJlc3VsdC50ZXh0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgZ2VuZXJhdGluZyBpbWFnZSBkZXNjcmlwdGlvbjpcIiwgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgZ2VuZXJhdGluZyBpbWFnZSBkZXNjcmlwdGlvblwiKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEltYWdlTWVzc2FnZShkYXRhOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGltYWdlRGVzY3JpcHRpb24gPSBhd2FpdCB0aGlzLmdldEltYWdlRGVzY3JpcHRpb24oZGF0YSk7XG4gICAgcmV0dXJuIGltYWdlRGVzY3JpcHRpb247XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEF1ZGlvTWVzc2FnZShkYXRhOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGF1ZGlvVXJsID0gYXdhaXQgczNTZXJ2aWNlLmdldFByZXNpZ25lZFVybChkYXRhKTtcbiAgICBjb25zdCB0cmFuc2NyaXB0aW9uID0gYXdhaXQgdHJhbnNjcmlwdGlvblNlcnZpY2UudHJhbnNjcmliZUF1ZGlvKGF1ZGlvVXJsKTtcbiAgICByZXR1cm4gdHJhbnNjcmlwdGlvbjtcbiAgfVxuICBwdWJsaWMgYXN5bmMgYWRkSm91cm5hbEVudHJ5KGVudHJ5OiBKb3VybmFsRW50cnlQYXlsb2FkKTogUHJvbWlzZTxNZW1vcnlbXT4ge1xuICAgIGxldCBtZXNzYWdlOiBzdHJpbmc7XG4gICAgc3dpdGNoIChlbnRyeS50eXBlKSB7XG4gICAgICBjYXNlIE1lZGlhVHlwZS5URVhUOlxuICAgICAgICBtZXNzYWdlID0gZW50cnkuZGF0YTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE1lZGlhVHlwZS5JTUFHRTpcbiAgICAgICAgbWVzc2FnZSA9IGF3YWl0IHRoaXMuZ2V0SW1hZ2VNZXNzYWdlKGVudHJ5LmRhdGEpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgTWVkaWFUeXBlLkFVRElPOlxuICAgICAgICBtZXNzYWdlID0gYXdhaXQgdGhpcy5nZXRBdWRpb01lc3NhZ2UoZW50cnkuZGF0YSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBtZWRpYSB0eXBlOiAke2VudHJ5LnR5cGV9YCk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LmFkZChtZXNzYWdlLCB7XG4gICAgICB1c2VyX2lkOiBlbnRyeS51c2VySWQsXG4gICAgICBtZXRhZGF0YToge1xuICAgICAgICAuLi5lbnRyeS5tZXRhZGF0YSxcbiAgICAgICAgZGF0YTogZW50cnkuZGF0YSxcbiAgICAgICAgdHlwZTogZW50cnkudHlwZSxcbiAgICAgIH0sXG4gICAgICBhcGlfdmVyc2lvbjogXCJ2MlwiLFxuICAgICAgaW5mZXI6IGZhbHNlLFxuICAgIH0pO1xuICAgIGNvbnNvbGUubG9nKFwicmVzdWx0XCIsIEpTT04uc3RyaW5naWZ5KHJlc3VsdCwgbnVsbCwgMikpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IE1lbTBTZXJ2aWNlKCk7XG4iXX0=